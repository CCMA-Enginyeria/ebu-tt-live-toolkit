<!DOCTYPE html>
<html>
   <head>
      <meta charset="UTF-8"></meta>
      <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
      <script src="nunjucks.js"></script>
   </head>
   <body>
      <button type="button" id="create-new-sequence-button" name="create-new-sequence-button">Create a new sequence</button>
      <div id="new-sequence-div" style="display: none">
         <label for="new-sequence-identifier-input">Sequence Identifier : </label>
         <input type="text" name="new-sequence-identifier-input" id="new-sequence-identifier-input">
         <button type="button" name="validate-new-sequence-button" id="validate-new-sequence-button">Validate</button>
         <button type="button" name="cancel-new-sequence-button" id="cancel-new-sequence-button">Cancel</button>
         <span id="new-sequence-notification-span"></span>
      </div>
      <br><br>
      <label for="post-url-input">Server URL: </label>
      <input type="url" id="post-url-input" name="post-url-input" value="http://127.0.0.1:9898" required><br>
      <form action="" id="subtitle-form">
         <label for="sequence-selector">Choose document sequence : </label>
         <select id="sequence-selector" name="sequence-selector"></select><br>
         <label for="subtitle-content">Subtitles text : </label>
         <textarea id="subtitle-content" name="subtitle-content" style="resize: both;" cols="160" rows="25"></textarea><br>
         <button id="reset-all" name="reset-all" type="reset">Reset</button>
         <button type="button" name="submit-subtitle" id="submit-subtitle">Submit</button><br>
         <span id="subtitle-form-notification-span" style="color: red;"></span>
      </form>
      <script>
         $(document).ready(function(){

            var sequence_numbers = {}

            if (typeof(Storage) === "undefined") {
               window.alert("You are using an old browser that does not allow to save data between session. Do not reload this page or you will lose your defined sequences.");
            }

            if (localStorage.sequence_selector) {
               $("#sequence-selector").html(localStorage.sequence_selector);
            }
            if (localStorage.sequence_numbers) {
               sequence_numbers = JSON.parse(localStorage.sequence_numbers);
            }

            function notifyError(element, notification) {
               element.css("color", "red");
               element.text(notification);
            }

            function notifySuccess(element, notification) {
               element.css("color", "green");
               element.text(notification);
            }

            function hideNewSequenceDiv() {
               $("#new-sequence-div").hide();
               $("#create-new-sequence-button").show();
               // Clear input on cancel
               $("#new-sequence-identifier-input").val("");
               $("#new-sequence-notification-span").text("");
            }

            function isValidURL(str)  {
               var pattern = new RegExp('^(https?:\\/\\/)?'+
                  '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|'+
                  '((\\d{1,3}\\.){3}\\d{1,3}))'+
                  '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*');
               return pattern.test(str);
            }

            // Toggle the display of the form to create a new sequence.
            $("#create-new-sequence-button").click(function(){
               if ($("#new-sequence-div").css("display") == "none") {
                  $("#new-sequence-div").show();
                  $("#create-new-sequence-button").hide();
               }
            });

            // Cancel the creation of a new sequence.
            $("#cancel-new-sequence-button").click(function(){
               if (!($("#new-sequence-div").css("display") == "none")) {
                  hideNewSequenceDiv();
               }
            });

            // Create a new sequence
            $("#validate-new-sequence-button").click(function(){
               if ($("#new-sequence-identifier-input").val() == "") {
                  notifyError($("#new-sequence-notification-span"), "The sequence identifier cannot be empty");
               } else {
                  var sequence_identifier = $("#new-sequence-identifier-input").val();
                  $("#sequence-selector")
                     .append($("<option></option>")
                        .attr("value", sequence_identifier)
                        .text(sequence_identifier));
                  sequence_numbers[sequence_identifier] = 1;
                  if (typeof(Storage) !== "undefined") {
                     localStorage.sequence_selector = $("#sequence-selector").html();
                     localStorage.sequence_numbers = JSON.stringify(sequence_numbers);
                  }
                  hideNewSequenceDiv();
               }
            });

            // Reset the whole page
            $("#reset-all").click(function(){
               $("#sequence-selector").html("");
               if (typeof(Storage) !== "undefined") {
                  $("#subtitle-form-notification-span").text("");
                  localStorage.clear();
               }
            });

            var exampleSocket = new WebSocket("ws://localhost:9000");

            nunjucks.configure('template', { autoescape: true });

            $("#submit-subtitle").click(function(){
               var sequence_identifier = $("#sequence-selector").val();
               var template_data = {
                  sequence_identifier: sequence_identifier,
                  sequence_number: sequence_numbers[sequence_identifier],
                  body_content: $("#subtitle-content").val()
               };
               /*if (post_url == "" || !isValidURL(post_url)) {
                  console.log("SALUT!");
                  notifyError($("#subtitle-form-notification-span"), "Please enter a valid URL in the corresponding field.");
               } else*/ if (sequence_identifier == null) {
                  notifyError($("#subtitle-form-notification-span"), "The sequence identifier cannot be undefined. Please create a new sequence.");
               } else {
                  var rendered_document = nunjucks.render('user_input_producer_template.xml', template_data);
                  exampleSocket.send(rendered_document);
                  sequence_numbers[sequence_identifier] += 1;
                  localStorage.sequence_numbers = JSON.stringify(sequence_numbers);
               }
            });
         });
      </script>
   </body>
</html>
