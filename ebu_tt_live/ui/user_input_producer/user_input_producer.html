<!DOCTYPE html>
<html>
   <head>
      <meta charset="UTF-8"></meta>
      <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
      <script src="template/user_input_producer_template.js"></script>
      <script src="nunjucks.js"></script>
   </head>
   <body>
      <button type="button" id="create-new-sequence-button" name="create-new-sequence-button">Create a new sequence</button>
      <div id="new-sequence-div" style="display: none">
         <label for="new-sequence-identifier-input">Sequence Identifier : </label>
         <input type="text" name="new-sequence-identifier-input" id="new-sequence-identifier-input">
         <button type="button" name="validate-new-sequence-button" id="validate-new-sequence-button">Validate</button>
         <button type="button" name="cancel-new-sequence-button" id="cancel-new-sequence-button">Cancel</button>
         <span id="new-sequence-notification-span"></span>
      </div>
      <br><br>
      <label for="websocket-url-input">Websocket server URL: </label>
      <input type="url" id="websocket-url-input" name="websocket-url-input" value="ws://127.0.0.1:9000" required>
      <button type="button" id="websocket-connect-button" name="websocket-connect-button">Connect</button>
      <button type="button" id="websocket-disconnect-button" name="websocket-disconnect-button" style="display: none">Disconnect</button>
      <span id="websocket-notifications-span" style="color: orange">Disconnected</span>
      <br><br>
      <br><br>
      Send documents live : <input type="radio" name="sending-type-radio-input" value="live" checked>
      Send documents on defined time : <input type="radio" name="sending-type-radio-input" value="set_time">
      <form action="" id="subtitle-form">
         <label for="sequence-selector">Choose document sequence : </label>
         <select id="sequence-selector" name="sequence-selector"></select>
         <br>
         <label for ="time-base-selector">Time base : </label>
         <select id="time-base-selector" name="time-base-selector">
            <option value="clock" selected="selected">Clock</option>
            <option value="media">Media</option>
            <option value="smpte">SMPTE</option>
         </select>
         <span id="clock-mode-span">
            <label for="clock-mode-selector">Clock mode : </label>
            <select id="clock-mode-selector" name="clock-mode-selector">
               <option value="local" selected="selected">Local</option>
               <option value="utc">UTC</option>
               <option value="gps">GPS</option>
            </select>
         </span>
         <br>
         <span id="smpte-attributes-span">
            <label for="frame-rate-input">Frame rate : </label>
            <input type="text" id="frame-rate-input" name="frame-rate-input">
            <br>
            <label for="frm-numerator-input"> Frame rate multiplier numerator : </label>
            <input type="text" id="frm-numerator-input" name="frm-numerator-input">
            <label for="frm-denominator-input">Frame rate multiplier denominator : </label>
            <input type="text" id="frm-denominator-input" name="frm-denominator-input">
            <br>
            <label for="marker-mode-selector">Marker mode : </label>
            <select id="marker-mode-selector" name="marker-mode-selector">
               <option value="continuous">continuous</option>
            </select>
            <br>
            <label for="drop-mode-selector">Drop mode : </label>
            <select id="drop-mode-selector" name="drop-mode-selector">
               <option value="nonDrop">nonDrop</option>
               <option value="dropNTSC">dropNTSC</option>
               <option value="dropPAL">dropPAL</option>
            </select>
         </span>
         <br>
         <label for="body-begin-input">Body begin time : </label>
         <input type="text" id="body-begin-input" name="body-begin-input">
         <label for="body-end-input">Body end time : </label>
         <input type="text" id="body-end-input" name="body-end-input">
         <label for="dur-input">Duration : </label>
         <input type="text" id="dur-input" name="dur-input">
         <br>
         <label for="subtitle-content-textarea">Subtitles text : </label><br>
         <textarea id="subtitle-content-textarea" name="subtitle-content-textarea" style="resize: both;" cols="160" rows="25"></textarea>
         <br>
         Sending time : <input type="text" id="sending-time-input" name="sending-time-input">
         <button type="button" name="submit-subtitle-button" id="submit-subtitle-button">Submit</button>
         <br><br>
         <button id="reset-all" name="reset-all" type="reset">Reset</button>
         <span id="subtitle-form-notification-span"></span>
      </form>
      <script>
         $(document).ready(function(){

            var sequence_numbers = {};

            if (typeof(Storage) === "undefined") {
               window.alert("You are using an old browser that does not allow to save data between session. Do not reload this page or you will lose your defined sequences.");
            }


            // Get data from local storage if it exists (we retain some data, like existing sequences and sequence numbers
            // on page reload. Also works when the browser is closed and reopened.
            if (localStorage.sequence_selector) {
               $("#sequence-selector").html(localStorage.sequence_selector);
            }
            if (localStorage.sequence_numbers) {
               sequence_numbers = JSON.parse(localStorage.sequence_numbers);
            }


            function handleTimeBaseDependingOptions() {
               var selected_time_base = $("#time-base-selector").val();
               if (selected_time_base == "clock") {
                  $("#clock-mode-span").show();
                  $("#smpte-attributes-span").hide();
               } else if (selected_time_base == "smpte") {
                  $("#clock-mode-span").hide();
                  $("#smpte-attributes-span").show();
               } else {
                  $("#clock-mode-span").hide();
                  $("#smpte-attributes-span").hide();
               }
            }

            handleTimeBaseDependingOptions();


            function handleSendingTypeDependingOptions() {
            }



            /************************************************** Helper functions ******************************************/
            function notifyError(element, notification) {
               element.css("color", "red");
               element.text(notification);
            }

            function notifyWarning(element, notification) {
               element.css("color", "orange");
               element.text(notification);
            }

            function notifySuccess(element, notification) {
               element.css("color", "green");
               element.text(notification);
            }

            function hideNewSequenceDiv() {
               $("#new-sequence-div").hide();
               $("#create-new-sequence-button").show();
               // Clear input on cancel
               $("#new-sequence-identifier-input").val("");
               $("#new-sequence-notification-span").text("");
            }

            function isValidURL(str)  {
               var pattern = new RegExp('^(ws?:\\/\\/)?'+
                  '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|'+
                  '((\\d{1,3}\\.){3}\\d{1,3}))'+
                  '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*');
               return pattern.test(str);
            }






            /******************************************* Websocket logic ***********************************************/

            var socket = {connected: false};

            function websocketOnError(e) {
               notifyError($("#websocket-notifications-span"), "Error: cannot connect to websocket server.");
               socket.connected = false;
               socket.websocket = null;
               $("#websocket-connect-button").show();
               $("#websocket-disconnect-button").hide();
            }

            function websocketOnOpen(e) {
               notifySuccess($("#websocket-notifications-span"), "Connected to websocket server");
               socket.connected = true;
               $("#websocket-connect-button").hide();
               $("#websocket-disconnect-button").show();
               socket.websocket.onclose = websocketOnClose;
            }

            function websocketOnClose(e) {
               notifyWarning($("#websocket-notifications-span"), "Connection to websocket server closed.");
               socket.connected = false;
               socket.websocket = null;
               $("#websocket-connect-button").show();
               $("#websocket-disconnect-button").hide();
            }

            function websocketOnMessage(e) {
               if (e.data == ("SUCCESS")) {
                  notifySuccess($("#subtitle-form-notification-span"), "Document successfully sent to server");
               } else {
                  notifyError($("#subtitle-form-notification-span"), e.data);
               }
            }






            /******************************************************** Page elements logic ***************************************/
            // Toggle the display of the form to create a new sequence.
            $("#create-new-sequence-button").click(function(){
               if ($("#new-sequence-div").css("display") == "none") {
                  $("#new-sequence-div").show();
                  $("#create-new-sequence-button").hide();
               }
            });

            // Cancel the creation of a new sequence.
            $("#cancel-new-sequence-button").click(function(){
               if (!($("#new-sequence-div").css("display") == "none")) {
                  hideNewSequenceDiv();
               }
            });

            // Create a new sequence
            $("#validate-new-sequence-button").click(function(){
               if ($("#new-sequence-identifier-input").val() == "") {
                  notifyError($("#new-sequence-notification-span"), "The sequence identifier cannot be empty");
               } else {
                  var sequence_identifier = $("#new-sequence-identifier-input").val();
                  $("#sequence-selector")
                     .append($("<option></option>")
                        .attr("value", sequence_identifier)
                        .text(sequence_identifier));
                  sequence_numbers[sequence_identifier] = 1;
                  if (typeof(Storage) !== "undefined") {
                     localStorage.sequence_selector = $("#sequence-selector").html();
                     localStorage.sequence_numbers = JSON.stringify(sequence_numbers);
                  }
                  hideNewSequenceDiv();
               }
            });

            // Reset the whole page
            $("#reset-all").click(function(){
               $("#sequence-selector").html("");
               if (typeof(Storage) !== "undefined") {
                  $("#subtitle-form-notification-span").text("");
                  localStorage.clear();
               }
            });

            $("#websocket-connect-button").click(function(){
               if (socket.connected == false) {
                  var websocket_url = $("#websocket-url-input").val();
                  socket.websocket = new WebSocket(websocket_url);
                  // onclose hook is not set yet because we need to know if the connection has been established
                  // and to get an error if not. However if onclose is defined it is called instead of onerror.
                  // So we define onclose in the onopen hook.
                  socket.websocket.onerror = websocketOnError;
                  socket.websocket.onopen = websocketOnOpen;
                  socket.websocket.onmessage = websocketOnMessage;
               }
            });

            $("#websocket-disconnect-button").click(function(){
               if (socket.connected == true) {
                  socket.websocket.close();
               }
            });

            $("#time-base-selector").change(function(){
               handleTimeBaseDependingOptions();
            });


            function createTemplateDict() {
               var template_data = {};
               sequence_identifier = $("#sequence-selector").val();
               template_data["sequence_identifier"] = sequence_identifier
               template_data["sequence_number"] = sequence_numbers[sequence_identifier] + 1;
               time_base = $("#time-base-selector").val();
               template_data["time_base"] = time_base;
               if (time_base == "clock") {
                  template_data["clock_mode"] = $("#clock-mode-selector").val();
               } else if (time_base == "smpte") {
                  template_data["frame_rate"] = $("#frame-rate-input").val();
                  template_data["frm_numerator"] = $("#frm-numerator-input").val();
                  template_data["frm_denominator"] = $("#frm-denominator-input").val();
                  template_data["marker_mode"] = $("#marker-mode-selector").val();
                  template_data["drop_mode"] = $("#drop-mode-selector").val();
               }
               template_data["body_content"] = $("#subtitle-content-textarea").val();
               template_data["body_begin"] = $("#body-begin-input").val();
               template_data["body_end"] = $("#body-end-input").val();
               template_data["dur"] = $("#dur-input").val();
               return template_data;
            }

            function sendDocument(doc, socket) {
               var sending_type = $("input[name=sending-type-radio-input]:checked").val();
               if (sending_type == "set_time") {
                  var sending_time = new Date(Date.now());
                  sending_time_input = $("#sending-time-input").val();
                  sending_time_parsed = sending_time_input.match(/(\d\d):(\d\d):(\d\d)/);
                  sending_time.setHours(sending_time_parsed[1]);
                  sending_time.setMinutes(sending_time_parsed[2]);
                  sending_time.setSeconds(sending_time_parsed[3]);
                  var timeout = sending_time.getTime() - Date.now();
                  setTimeout(function(doc, socket){ socket.websocket.send(doc) }, timeout, doc, socket);
               }
            }

            $("#submit-subtitle-button").click(function(){
               var sequence_identifier = $("#sequence-selector").val();
               if (sequence_identifier == null) {
                  notifyError($("#subtitle-form-notification-span"), "The sequence identifier cannot be undefined. Please create a new sequence.");
               } else {
                  var template_data = createTemplateDict();
                  var rendered_document = nunjucks.render('ebu_tt_live/ui/user_input_producer/template/user_input_producer_template.xml', template_data);
                  console.log(rendered_document);
                  //socket.websocket.send(rendered_document);
                  sendDocument(rendered_document, socket);
                  sequence_numbers[sequence_identifier] += 1;
                  localStorage.sequence_numbers = JSON.stringify(sequence_numbers);
               }
            });
         });
      </script>
   </body>
</html>
